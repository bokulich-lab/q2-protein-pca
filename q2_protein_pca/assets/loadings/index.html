{% extends 'base.html' %}

{% block head %}
  <script src="js/vega.min.js"></script>
  <script src="js/vega-embed.min.js"></script>
  <link rel="stylesheet" type="text/css" href="css/spinkit.css">
{% endblock %}

{% block content %}

<div class="row">
  <div class="col-lg-8">
    <h3>Protein PCA loadings plot</h3>
    <div id="toolbar"></div>
    {% if vega_spec is defined %}
    <div id="plot">
      <div id="loading" class="spinner">
        <div class="rect1"></div>
        <div class="rect2"></div>
        <div class="rect3"></div>
        <div class="rect4"></div>
        <div class="rect5"></div>
      </div>
    </div>
    {% else %}
    <p>Unable to generate PCA loadings plot</p>
    {% endif %}
  </div>

  <div class="col-lg-4">
    <div class="row">
      <div class="col-lg-12">
        <h3>Plot Controls</h3>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-12" id="toolbar"></div>
    </div>

    <div class="row">
      <div class="col-lg-12" id="conservation-level-slider"></div>
    </div>
    <br>
    <div class="row">
      <div class="col-lg-12" id="text-field"></div>
    </div>
  </div>
</div>

<hr>
{% endblock %}

{% block footer %}
{% set loading_selector = '#loading' %}
{% include 'js-error-handler.html' %}
{% if vega_spec is defined %}
<script id="spec" type="application/json">{{ vega_spec }}</script>

<script type="text/javascript">
  $(document).ready(function() {
    var spec = JSON.parse(document.getElementById('spec').innerHTML);

    // Try and come up with a good initial estimate of plot dimensions,
    // based on the browser dimensions.
    var width = $('#plot').width() / 1.5;
    var opts = {
      width: width,
      height: width
    };

    vegaEmbed('#plot', spec, opts).then(function(result) {
      result.view.logLevel(vega.Warn);
      // Stash the view object in global namespace for debugging purposes.
      // Check out https://vega.github.io/vega/docs/api/debugging/
      // for more details.
      window.v = result.view;
    }).catch(function(error) {
      // From 'js-error-handler.html'
      handleErrors([error], $('#plot'));
    });

    // Clean up the vega-embed toolbar
    var toolbar = $('div .vega-actions').detach();
    toolbar.addClass('btn-group');
    toolbar.children('a').each(function() {
      // NOTE: We're just skipping this bit until we get the plot working with
      // Vega 5
      if(this.innerHTML == "Open in Vega Editor"){
        this.remove()
        return true
      }
      $(this).addClass('btn btn-default');
    });
    $('<a href="data.tsv" target="_blank" rel="noopener noreferrer" class="btn btn-default">Export as TSV</a>')
      .prependTo(toolbar);
    toolbar.appendTo('#toolbar');

    var conservationLevelSlider = $("#conservation-level-slider .vega-bind");
    $(conservationLevelSlider)
      .find("label")
      .remove();
    $(conservationLevelSlider)
      .find("input")
      .attr("id", "range-slider");
    $(conservationLevelSlider)
      .find("input")
      .attr("oninput", "sliderHelperFunction(this.value);");
    $(conservationLevelSlider).prepend(
      "<label> Conservation Level [%] &nbsp; </label> <br>"
    );
    $(conservationLevelSlider).append(
      '<br> <input id="text-box" class="form-control" type="number" value="90" min="0" oninput="textBoxHelperFunction(this.value);" />'
    );
    conservationLevelSlider.children(".vega-bind-name").replaceWith("");
  });
</script>

{% else %}

<div class="row">
  <div class="col-lg-4">
    <div class="row">
      <div class="col-lg-12" id="sampling-depth-slider">
        <label> Sampling Depth &nbsp; </label> <br>
        <input id="range-slider" type="range" min="0" max="100" value="0" class="slider" oninput="sliderHelperFunction(this.value);"> <br>
        <input id="text-box" class="form-control" type="number" value="0" min="0" oninput="textBoxHelperFunction(this.value);"/>
        <br>
        <div class="row">
          <div class="col-lg-12" id="text-field"></div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endif %}

<div class="row">
  <div class="col-lg-8">
    <table id="feature-table" class="table table-striped">
      <thead>
        <tr>
          <th scope="col">Position within alignment</th>
          <th scope="col">PC1</th>
          <th scope="col">PC2</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>
</div>

<script id="table-data" type="application/json">
{{ pca_data }}
</script>

<script type="text/javascript">
  var tableBody = document.getElementById("table-body");
  var table = document.getElementById("feature-table");
  var textField = document.getElementById('text-field');

  var pcaData = JSON.parse(document.getElementById("table-data").innerHTML);
  // get object keys and store them in an ascending order based on the key value
  // this order is used to create the table rows
  var defaultDescription = `${pcaData.length} positions (100%) found at a
                                  conservation level of at least 0%.`;

  // when the viz loads the default description is displayed
  textField.innerHTML = defaultDescription;

  console.log(pcaData)
  sortedPositionIDs = Object.keys(pcaData).sort(function(a, b){
    return pcaData[b].euclid_dist - pcaData[a].euclid_dist
  });
  sortedPositionIDs.forEach(function(element) {
    var row = tableBody.insertRow(0);
    var cell1 = row.insertCell(0);
    var cell2 = row.insertCell(1);
    var cell3 = row.insertCell(2);
    cell1.innerHTML = element;
    cell2.innerHTML = pcaData[element].PC1;
    cell3.innerHTML = pcaData[element].PC2;
  });

  updateTableandText(90)

  function updateTableandText(val) {
    var conservationThreshold = val / 100
    var maxDistance = {{ max_distance }}
    var conservedPositions = 0
    console.log(conservationThreshold, maxDistance)

    // start the counter at 1 to ignore the header row
    for (var i = 1; row = table.rows[i]; i++) {
      var posId = Number(row.cells[0].innerHTML)
      if (Number(pcaData[posId].euclid_dist) / maxDistance <= (1 - conservationThreshold)) {
        row.className = "danger";
        conservedPositions += 1
      } else {
        row.className = "";
      }
    }

    if (val === 0){
      textField.innerHTML = defaultDescription;
    }
    else{
      var percentConserved = (conservedPositions * 100 / pcaData.length).toFixed(1);
      textField.innerHTML = `${conservedPositions} positions (${percentConserved}%) found at a
                                  conservation level of at least ${val}%.`
    }

  }

  function updateSliderVal(val) {
    var slider = document.getElementById("range-slider");
    slider.value = val;
    slider.dispatchEvent(new Event("change"));
    slider.dispatchEvent(new Event("input"));
  }

  function updateBoxVal(val) {
    var num = document.getElementById("text-box");
    num.value = val;
  }

  function sliderHelperFunction(val){
    updateBoxVal(val);
    updateTableandText(val);
  }

  function textBoxHelperFunction(val){
    val = parseInt(val);
    if (val !== val) {
      val = 0;
    }

    // make sure the value in the textbox cannot exceed the max count
    if (val > {{ max_count }}){
      var num = document.getElementById("text-box");
      num.value = {{ max_count }}
    }
    updateSliderVal(val);
  }
</script>

{% endblock %}